<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1, h2 {
            color: #2c3e50;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .tab-container {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 8px 8px 0 0;
        }
        .tab-button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
        }
        .tab-button:hover {
            background-color: #ddd;
        }
        .tab-button.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        #registrantsTable {
            overflow-x: auto;
        }
        
        /* Fee Calculator Styles */
        .calculator-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .calculator-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .fee-input-group {
            margin-bottom: 15px;
        }
        .fee-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .fee-input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .fee-result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .fee-total {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
            margin-top: 10px;
        }
        .fee-total.negative {
            color: #e74c3c;
        }
        .fee-breakdown {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        .profit-formula {
            font-size: 16px;
            font-weight: bold;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: inline-block;
        }
        .formula-variable {
            font-style: italic;
            color: #3498db;
            margin: 0 5px;
        }
        .calculator-section-header {
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #2c3e50;
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .table-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .table-filter-container input,
        .table-filter-container select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .table-filter-container .search-input {
            flex-grow: 1;
            min-width: 200px;
        }
        .table-filter-container .filter-section,
        .table-filter-container .filter-rated {
            min-width: 150px;
        }
        .table-filter-container .date-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .table-filter-container .date-filter label {
            white-space: nowrap;
        }
        #registrantsTable .no-results {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #6c757d;
        }
        #registrantsTable table tr.filtered-out {
            display: none;
        }
        .time-slider-container {
            margin-top: 15px; 
            display: flex; 
            align-items: center;
        }
        #timelineSlider {
            flex-grow: 1; 
            margin-right: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chess Tournament Registration Dashboard</h1>
        
        <div class="upload-section">
            <h2>Upload Registration CSV</h2>
            <input type="file" id="csvFileInput" accept=".csv" />
            <button class="btn" id="uploadBtn">Process Data</button>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <div class="stats-container" id="statsContainer">
            <!-- Stats cards will be inserted here -->
        </div>
        
        <div class="tab-container">
            <button class="tab-button active" onclick="openTab(event, 'graphsTab')">Graphs</button>
            <button class="tab-button" onclick="openTab(event, 'tableTab')">Registrants</button>
            <button class="tab-button" onclick="openTab(event, 'calculatorTab')">Revenue & Profit Calculator</button>
        </div>
        
        <div id="graphsTab" class="tab-content" style="display: block;">
            <div class="dashboard">
                <div class="chart-container">
                    <h2>Sections Breakdown</h2>
                    <canvas id="sectionsChart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>Rated vs Unrated Players</h2>
                    <canvas id="ratedChart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>Registration Timeline</h2>
                    <canvas id="timelineChart"></canvas>
                    <div id="timeSliderContainer" class="time-slider-container" style="display: none;">
                        <input type="range" id="timelineSlider" min="0" max="100" value="100">
                        <span id="sliderDateDisplay">Full Timeline</span>
                    </div>
                </div>
                <div class="calculator-container">
                    <div class="calculator-title">Quick Fee Calculator</div>
                    <div class="fee-input-group">
                        <label for="ratedFee">Fee per Rated Player ($)</label>
                        <input type="number" id="ratedFee" value="25" min="0" step="0.01">
                    </div>
                    <div class="fee-input-group">
                        <label for="unratedFee">Fee per Unrated Player ($)</label>
                        <input type="number" id="unratedFee" value="20" min="0" step="0.01">
                    </div>
                    <button class="btn" id="calculateBtn">Calculate Total</button>
                    
                    <div class="fee-result">
                        <div>Based on current registrations:</div>
                        <div id="ratedCount" class="fee-breakdown">Rated Players: 0</div>
                        <div id="unratedCount" class="fee-breakdown">Unrated Players: 0</div>
                        <div id="feeTotal" class="fee-total">$0.00</div>
                        <div id="feeBreakdown" class="fee-breakdown"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="tableTab" class="tab-content">
            <div id="registrantsTable">
                <!-- Table will be inserted here -->
            </div>
        </div>
        
        <div id="calculatorTab" class="tab-content">
            <div class="calculator-container">
                <div class="calculator-title">Tournament Revenue & Profit Calculator</div>
                
                <h3 class="calculator-section-header">Revenue Calculation</h3>
                <div class="calculator-grid">
                    <div>
                        <div class="fee-input-group">
                            <label for="ratedFeeCalc">Fee per Rated Player ($)</label>
                            <input type="number" id="ratedFeeCalc" value="25" min="0" step="0.01">
                        </div>
                        <div class="fee-input-group">
                            <label for="unratedFeeCalc">Fee per Unrated Player ($)</label>
                            <input type="number" id="unratedFeeCalc" value="20" min="0" step="0.01">
                        </div>
                    </div>
                    
                    <div>
                        <div class="fee-result">
                            <div>Revenue breakdown:</div>
                            <div id="ratedCountCalc" class="fee-breakdown">Rated Players: 0</div>
                            <div id="unratedCountCalc" class="fee-breakdown">Unrated Players: 0</div>
                            <div id="ratedRevenueCalc" class="fee-breakdown">Revenue from rated players: $0.00</div>
                            <div id="unratedRevenueCalc" class="fee-breakdown">Revenue from unrated players: $0.00</div>
                            <div id="totalRevenueCalc" class="fee-total">Total Revenue: $0.00</div>
                        </div>
                    </div>
                </div>
                
                <h3 class="calculator-section-header">Profit Calculation</h3>
                <div class="profit-formula">
                    Profit = Revenue - Expenses
                </div>
                
                <div class="calculator-grid">
                    <div>
                        <div class="fee-input-group">
                            <label for="venueCost">Venue Cost ($)</label>
                            <input type="number" id="venueCost" value="200" min="0" step="1">
                        </div>
                        <div class="fee-input-group">
                            <label for="prizeCost">Prize Costs ($)</label>
                            <input type="number" id="prizeCost" value="200" min="0" step="1">
                        </div>
                        <div class="fee-input-group">
                            <label for="otherCosts">Other Costs ($)</label>
                            <input type="number" id="otherCosts" value="0" min="0" step="1">
                        </div>
                        <button class="btn" id="calculateProfitBtn">Calculate Profit/Loss</button>
                    </div>
                    
                    <div>
                        <div class="fee-result">
                            <div>Profit/Loss calculation:</div>
                            <div id="totalRevenueProfit" class="fee-breakdown">Total Revenue: $0.00</div>
                            <div id="venueExpense" class="fee-breakdown">Venue expense: $0.00</div>
                            <div id="prizeExpense" class="fee-breakdown">Prize expense: $0.00</div>
                            <div id="otherExpense" class="fee-breakdown">Other expenses: $0.00</div>
                            <div id="totalExpense" class="fee-breakdown">Total expenses: $0.00</div>
                            <div id="profitTotal" class="fee-total">Profit: $0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store the data
        let registrationData = [];
        let sections = {};
        let registrationTimeline = {};
        let ratedPlayersCount = 0;
        let unratedPlayersCount = 0;
        
        // Define chart instances to update later
        let sectionsChart;
        let ratedChart;
        let timelineChart;
        
        // Initialize with default data if available via the window.fs API
        async function init() {
            try {
                const response = await window.fs.readFile('Windsor Open Chess Tournament  March 22 2025 Responses  Form Responses 1.csv', { encoding: 'utf8' });
                processCSVData(response);
            } catch (error) {
                console.log("No default file available, waiting for user upload.");
                document.getElementById('fileInfo').textContent = "No data loaded. Please upload a CSV file.";
            }
        }
        
        // Process uploaded CSV file
        document.getElementById('uploadBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (file) {
                document.getElementById('fileInfo').textContent = "Processing file: " + file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvData = e.target.result;
                    processCSVData(csvData);
                };
                reader.readAsText(file);
            } else {
                alert("Please select a CSV file.");
            }
        });
        
        // Function to process CSV data
        function processCSVData(csvData) {
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    registrationData = results.data;
                    
                    // Update file info
                    document.getElementById('fileInfo').textContent = "Loaded " + registrationData.length + " registrations successfully.";
                    
                    // Analyze the data
                    analyzeData();
                    
                    // Update the UI
                    updateStats();
                    updateCharts();
                    createRegistrantsTable();
                    updateFeeCalculator();
                    updateProfitCalculator();
                },
                error: function(error) {
                    console.error("Error parsing CSV:", error);
                    document.getElementById('fileInfo').textContent = "Error processing file. Please check format.";
                }
            });
        }
        
        // Analyze the data to extract metrics
        function analyzeData() {
            // Reset data containers
            sections = {};
            registrationTimeline = {};
            
            // Process sections
            registrationData.forEach(entry => {
                const section = entry["What section?"];
                if (section) {
                    sections[section] = (sections[section] || 0) + 1;
                }
                
                // Process timestamps for timeline
                if (entry["Timestamp"]) {
                    // Handle various date formats
                    let timestamp;
                    const timestampStr = entry["Timestamp"];
                    
                    // Try different date formats
                    if (timestampStr.includes('/')) {
                        // Format like MM/DD/YYYY or M/D/YYYY
                        const parts = timestampStr.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            // Assuming MM/DD/YYYY format
                            const month = parseInt(parts[0]) - 1; // JS months are 0-indexed
                            const day = parseInt(parts[1]);
                            const year = parseInt(parts[2]);
                            timestamp = new Date(year, month, day);
                        }
                    } else {
                        // Try standard date parsing
                        timestamp = new Date(timestampStr);
                    }
                    
                    if (timestamp && !isNaN(timestamp.getTime())) {
                        const dateStr = timestamp.toISOString().split('T')[0];
                        registrationTimeline[dateStr] = (registrationTimeline[dateStr] || 0) + 1;
                    }
                }
            });
            
            // Sort the timeline by date
            registrationTimeline = Object.fromEntries(
                Object.entries(registrationTimeline).sort(([a], [b]) => new Date(a) - new Date(b))
            );
            
            // Count rated and unrated players
            ratedPlayersCount = registrationData.filter(entry => 
                entry["CFC ID (ONLY if playing in a rated section)"] !== null && 
                !isNaN(entry["CFC ID (ONLY if playing in a rated section)"])
            ).length;
            
            unratedPlayersCount = registrationData.length - ratedPlayersCount;
        }
        
        // Update stats cards
        function updateStats() {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = ''; // Clear existing stats
            
            // Total registrants
            const totalCard = createStatCard(registrationData.length, "Total Registrants");
            statsContainer.appendChild(totalCard);
            
            // Count players with CFC ID
            const ratedCard = createStatCard(ratedPlayersCount, "Rated Players");
            statsContainer.appendChild(ratedCard);
            
            const unratedCard = createStatCard(unratedPlayersCount, "Unrated Players");
            statsContainer.appendChild(unratedCard);
            
            // Most popular section
            if (Object.keys(sections).length > 0) {
                const mostPopularSection = Object.keys(sections).reduce((a, b) => 
                    sections[a] > sections[b] ? a : b
                );
                
                const sectionCard = createStatCard(
                    sections[mostPopularSection], 
                    `Most Popular: ${mostPopularSection}`
                );
                statsContainer.appendChild(sectionCard);
            }
        }
        
        // Create a stat card element
        function createStatCard(value, label) {
            const card = document.createElement('div');
            card.className = 'stat-card';
            
            const valueEl = document.createElement('div');
            valueEl.className = 'stat-value';
            valueEl.textContent = value;
            
            const labelEl = document.createElement('div');
            labelEl.className = 'stat-label';
            labelEl.textContent = label;
            
            card.appendChild(valueEl);
            card.appendChild(labelEl);
            
            return card;
        }
        
        // Update all charts
        function updateCharts() {
            updateSectionsChart();
            updateRatedChart();
            updateTimelineChart();
        }
        
        // Update the sections breakdown chart
        function updateSectionsChart() {
            const ctx = document.getElementById('sectionsChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (sectionsChart) {
                sectionsChart.destroy();
            }
            
            const sectionLabels = Object.keys(sections);
            const sectionData = sectionLabels.map(label => sections[label]);
            
            // Generate colors for sections
            const backgroundColors = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)'
            ];
            
            // Create modified labels with count
            const labelsWithCount = sectionLabels.map(label => `${label} (${sections[label]})`);
            
            sectionsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labelsWithCount,
                    datasets: [{
                        data: sectionData,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    const originalLabel = sectionLabels[context.dataIndex];
                                    return `${originalLabel}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update the rated vs unrated players chart
        function updateRatedChart() {
            const ctx = document.getElementById('ratedChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (ratedChart) {
                ratedChart.destroy();
            }
            
            ratedChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Rated Players', 'Unrated Players'],
                    datasets: [{
                        data: [ratedPlayersCount, unratedPlayersCount],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update the registration timeline chart
        function updateTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            // Generate a complete date range to fill in gaps
            let allDates = [];
            if (Object.keys(registrationTimeline).length > 0) {
                // Find min and max dates
                const minDate = new Date(Math.min(...Object.keys(registrationTimeline).map(d => new Date(d).getTime())));
                const maxDate = new Date(Math.max(...Object.keys(registrationTimeline).map(d => new Date(d).getTime())));
                
                // Create array of all dates in range
                const currentDate = new Date(minDate);
                while (currentDate <= maxDate) {
                    allDates.push(currentDate.toISOString().split('T')[0]);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else {
                allDates = [];
            }
            
            // Format dates for display (e.g., Feb 15)
            const formattedDates = allDates.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            // Fill in registration counts, using 0 for days with no registrations
            const registrationCounts = allDates.map(date => registrationTimeline[date] || 0);
            
            // Calculate cumulative registrations
            const cumulativeData = [];
            let cumulative = 0;
            for (const count of registrationCounts) {
                cumulative += count;
                cumulativeData.push(cumulative);
            }
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedDates,
                    datasets: [
                        {
                            label: 'Daily Registrations',
                            data: registrationCounts,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y',
                            type: 'bar'
                        },
                        {
                            label: 'Cumulative Registrations',
                            data: cumulativeData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y1',
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 20
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Daily Count'
                            },
                            suggestedMax: Math.max(...registrationCounts) + 1
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cumulative Count'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return allDates[context[0].dataIndex];
                                }
                            }
                        }
                    }
                }
            });

            // Show the time slider container
            const sliderContainer = document.getElementById('timeSliderContainer');
            sliderContainer.style.display = 'flex';

            // Set up the time slider
            const slider = document.getElementById('timelineSlider');
            const dateDisplay = document.getElementById('sliderDateDisplay');

            slider.addEventListener('input', function() {
                const sliderValue = parseInt(this.value);
                const dataLength = formattedDates.length;
                
                // Calculate the number of data points to show based on slider value
                const dataPointsToShow = Math.ceil((sliderValue / 100) * dataLength);

                // Slice the data
                const displayDates = formattedDates.slice(0, dataPointsToShow);
                const displayDailyData = registrationCounts.slice(0, dataPointsToShow);
                const displayCumulativeData = cumulativeData.slice(0, dataPointsToShow);

                // Update the chart with sliced data
                timelineChart.data.labels = displayDates;
                timelineChart.data.datasets[0].data = displayDailyData;
                timelineChart.data.datasets[1].data = displayCumulativeData;
                timelineChart.update();

                // Update date display
                if (dataPointsToShow === dataLength) {
                    dateDisplay.textContent = 'Full Timeline';
                } else {
                    const lastDisplayedDate = new Date(allDates[dataPointsToShow - 1]);
                    dateDisplay.textContent = `Up to ${lastDisplayedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                }
            });
        }
        
        // Modify createRegistrantsTable function to add filters
        function createRegistrantsTable() {
            const tableContainer = document.getElementById('registrantsTable');
            
            if (registrationData.length === 0) {
                tableContainer.innerHTML = '<p>No data available.</p>';
                return;
            }
            
            // Create filter container
            const filterContainer = document.createElement('div');
            filterContainer.className = 'table-filter-container';
            
            // Search input
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search registrants...';
            searchInput.className = 'search-input';
            
            // Section filter
            const sectionFilter = document.createElement('select');
            sectionFilter.className = 'filter-section';
            const sectionOption = document.createElement('option');
            sectionOption.value = '';
            sectionOption.textContent = 'All Sections';
            sectionFilter.appendChild(sectionOption);
            
            // Populate section filter options
            Object.keys(sections).forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionFilter.appendChild(option);
            });
            
            // Rated filter
            const ratedFilter = document.createElement('select');
            ratedFilter.className = 'filter-rated';
            ratedFilter.innerHTML = `
                <option value="">All Players</option>
                <option value="rated">Rated Players</option>
                <option value="unrated">Unrated Players</option>
            `;
            
            // Date range filter
            const dateFilterContainer = document.createElement('div');
            dateFilterContainer.className = 'date-filter';
            dateFilterContainer.innerHTML = `
                <label>From:</label>
                <input type="date" id="startDateFilter">
                <label>To:</label>
                <input type="date" id="endDateFilter">
            `;
            
            // Add filters to container
            filterContainer.appendChild(searchInput);
            filterContainer.appendChild(sectionFilter);
            filterContainer.appendChild(ratedFilter);
            filterContainer.appendChild(dateFilterContainer);
            
            // Create table
            const table = document.createElement('table');
            
            // Create header row
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // Get column headers (assuming first entry has all headers)
            const headers = Object.keys(registrationData[0]);
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            registrationData.forEach(entry => {
                const row = document.createElement('tr');
                
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = entry[header] !== null ? entry[header] : '';
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            
            // Clear previous content and add new elements
            tableContainer.innerHTML = '';
            tableContainer.appendChild(filterContainer);
            tableContainer.appendChild(table);
            
            // Add filter functionality
            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedSection = sectionFilter.value;
                const ratedStatus = ratedFilter.value;
                const startDate = new Date(document.getElementById('startDateFilter').value);
                const endDate = new Date(document.getElementById('endDateFilter').value);
                
                const rows = tbody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    let showRow = true;
                    
                    // Search filter
                    if (searchTerm) {
                        const rowText = row.textContent.toLowerCase();
                        showRow = rowText.includes(searchTerm);
                    }
                    
                    // Section filter
                    if (showRow && selectedSection) {
                        const sectionCell = row.cells[headers.indexOf('What section?')];
                        showRow = !selectedSection || sectionCell.textContent === selectedSection;
                    }
                    
                    // Rated filter
                    if (showRow && ratedStatus) {
                        const cfcIdCell = row.cells[headers.indexOf('CFC ID (ONLY if playing in a rated section)')];
                        const hasValidCFCId = cfcIdCell.textContent && !isNaN(cfcIdCell.textContent);
                        
                        if (ratedStatus === 'rated') {
                            showRow = hasValidCFCId;
                        } else if (ratedStatus === 'unrated') {
                            showRow = !hasValidCFCId;
                        }
                    }
                    
                    // Date filter
                    if (showRow && (startDate.toString() !== 'Invalid Date' || endDate.toString() !== 'Invalid Date')) {
                        const timestampCell = row.cells[headers.indexOf('Timestamp')];
                        const rowDate = new Date(timestampCell.textContent);
                        
                        if (startDate.toString() !== 'Invalid Date' && rowDate < startDate) {
                            showRow = false;
                        }
                        
                        if (showRow && endDate.toString() !== 'Invalid Date' && rowDate > endDate) {
                            showRow = false;
                        }
                    }
                    
                    // Toggle row visibility
                    row.style.display = showRow ? '' : 'none';
                }
                
                // Show/hide no results message
                const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
                const noResultsRow = tbody.querySelector('.no-results-row');
                
                if (visibleRows.length === 0) {
                    if (!noResultsRow) {
                        const newNoResultsRow = document.createElement('tr');
                        newNoResultsRow.className = 'no-results-row';
                        const noResultsCell = document.createElement('td');
                        noResultsCell.setAttribute('colspan', headers.length);
                        noResultsCell.className = 'no-results';
                        noResultsCell.textContent = 'No results found matching your filters.';
                        newNoResultsRow.appendChild(noResultsCell);
                        tbody.appendChild(newNoResultsRow);
                    }
                } else if (noResultsRow) {
                    tbody.removeChild(noResultsRow);
                }
            }
            
            // Add event listeners to filters
            searchInput.addEventListener('input', applyFilters);
            sectionFilter.addEventListener('change', applyFilters);
            ratedFilter.addEventListener('change', applyFilters);
            document.getElementById('startDateFilter').addEventListener('change', applyFilters);
            document.getElementById('endDateFilter').addEventListener('change', applyFilters);
        }
        
        // Update fee calculator with player counts
        function updateFeeCalculator() {
            // Update player counts
            document.getElementById('ratedCount').textContent = `Rated Players: ${ratedPlayersCount}`;
            document.getElementById('unratedCount').textContent = `Unrated Players: ${unratedPlayersCount}`;
            
            // Attach listeners to calculate buttons
            document.getElementById('calculateBtn').addEventListener('click', calculateFees);
            
            // Initial calculation
            calculateFees();
        }
        
        // Update the profit calculator with player counts
        function updateProfitCalculator() {
            // Update player counts
            document.getElementById('ratedCountCalc').textContent = `Rated Players: ${ratedPlayersCount}`;
            document.getElementById('unratedCountCalc').textContent = `Unrated Players: ${unratedPlayersCount}`;
            
            // Add event listeners for all inputs to recalculate
            document.getElementById('ratedFeeCalc').addEventListener('input', calculateRevenue);
            document.getElementById('unratedFeeCalc').addEventListener('input', calculateRevenue);
            document.getElementById('calculateProfitBtn').addEventListener('click', calculateProfit);
            
            // Initial calculations
            calculateRevenue();
            calculateProfit();
        }
        
        // Calculate revenue based on player counts and fees
        function calculateRevenue() {
            const ratedFee = parseFloat(document.getElementById('ratedFeeCalc').value) || 0;
            const unratedFee = parseFloat(document.getElementById('unratedFeeCalc').value) || 0;
            
            const ratedRevenue = ratedPlayersCount * ratedFee;
            const unratedRevenue = unratedPlayersCount * unratedFee;
            const totalRevenue = ratedRevenue + unratedRevenue;
            
            document.getElementById('ratedRevenueCalc').textContent = `Revenue from rated players ($${ratedFee} each): $${ratedRevenue.toFixed(2)}`;
            document.getElementById('unratedRevenueCalc').textContent = `Revenue from unrated players ($${unratedFee} each): $${unratedRevenue.toFixed(2)}`;
            document.getElementById('totalRevenueCalc').textContent = `Total Revenue: $${totalRevenue.toFixed(2)}`;
            
            // Update the revenue in the profit section
            document.getElementById('totalRevenueProfit').textContent = `Total Revenue: $${totalRevenue.toFixed(2)}`;
            
            return totalRevenue;
        }
        
        // Calculate profit based on revenue and expenses
        function calculateProfit() {
            const totalRevenue = calculateRevenue();
            const venueCost = parseFloat(document.getElementById('venueCost').value) || 0;
            const prizeCost = parseFloat(document.getElementById('prizeCost').value) || 0;
            const otherCosts = parseFloat(document.getElementById('otherCosts').value) || 0;
            
            const totalExpenses = venueCost + prizeCost + otherCosts;
            const profit = totalRevenue - totalExpenses;
            
            document.getElementById('venueExpense').textContent = `Venue expense: $${venueCost.toFixed(2)}`;
            document.getElementById('prizeExpense').textContent = `Prize expense: $${prizeCost.toFixed(2)}`;
            document.getElementById('otherExpense').textContent = `Other expenses: $${otherCosts.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `Total expenses: $${totalExpenses.toFixed(2)}`;
            
            const profitElement = document.getElementById('profitTotal');
            if (profit >= 0) {
                profitElement.textContent = `Profit: $${profit.toFixed(2)}`;
                profitElement.className = 'fee-total';
            } else {
                profitElement.textContent = `Loss: $${Math.abs(profit).toFixed(2)}`;
                profitElement.className = 'fee-total negative';
            }
        }
        
        // Calculate fees for the small calculator
        function calculateFees() {
            const ratedFee = parseFloat(document.getElementById('ratedFee').value) || 0;
            const unratedFee = parseFloat(document.getElementById('unratedFee').value) || 0;
            
            const ratedTotal = ratedPlayersCount * ratedFee;
            const unratedTotal = unratedPlayersCount * unratedFee;
            const grandTotal = ratedTotal + unratedTotal;
            
            document.getElementById('feeTotal').textContent = `$${grandTotal.toFixed(2)}`;
            document.getElementById('feeBreakdown').textContent = 
                `Rated: $${ratedTotal.toFixed(2)} + Unrated: $${unratedTotal.toFixed(2)}`;
        }
        
        // Tab functionality
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = 'none';
            }
            
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].className = tabButtons[i].className.replace(' active', '');
            }
            
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.className += ' active';
        }
        
        // Initialize the dashboard
        window.onload = init;
    </script>
</body>
</html>
